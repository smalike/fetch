/*! fetch-Module - v0.1.0 - 2015-04-23 12:23:41 */
define("common:chinaso/page/controller/image.stream",["require","exports","module","common:chinaso/page/common/ie.version"],function(a,b,c){function d(a){this.defaults={itemW:240,url:"",json_index:0,loadPageSize:9999,content_mar:10,totalPage:10,buildContainer:"",container:"",itemSelector:""},this.defaults=jQuery.extend(this.defaults,a),this.initialize(),this.resetMasonry()}var e=a("common:chinaso/page/common/ie.version");jQuery.extend(d.prototype,{initialize:function(a){var b=this;b.getItemW($(this.defaults.buildContainer).width()),7===e&&(this.defaults.itemW=this.defaults.itemW-1),$("#page-nav a").attr("href",this.defaults.url+this.defaults.jsonpath+"/data_2.json"),b.getData().done(function(a){b.defaults.totalPage=a.totalPage,b.initializeMasonry(),b.initializeInfinit(a.totalPage),b.ajaxCallback(a)}),b.eventHandler()},getItemW:function(a){var b;b=a/this.defaults.itemW,this.defaults.itemW=Math.floor(a/b)},eventHandler:function(){var a=this;$("#clickLoading").on("click",function(){a.getData().done(function(b){a.defaults.totalPage=b.totalPage,a.initializeMasonry(),a.ajaxCallback(b)})}),$(window).bind("resize",function(b){clearTimeout(a.resizeTimeId),a.resizeTimeId=setTimeout(function(){a.resizeWidth($(".item"))},300)})},initializeMasonry:function(){$(this.defaults.container).masonry({itemSelector:this.defaults.itemSelector,columnWidth:this.defaults.itemW+10-1,isFitWidth:!0,isAnimated:!0})},resetMasonry:function(){$(this.defaults.container).masonry()?$(this.defaults.container).masonry("destroy").css("height",0).html(""):""},initializeInfinit:function(a){var b=this;$(this.defaults.container).infinitescroll("destroy"),$(this.defaults.container).infinitescroll({speed:"slow",navSelector:"#page-nav",nextSelector:"#page-nav a",itemSelector:this.defaults.itemSelector,extraScrollPx:0,loading:{msgText:"正在加载...",finishedMsg:"加载完毕！",selector:"#loading",img:"http://www.chinaso.com/common/base/image/loading.gif"},state:{isDuringAjax:!1,isInvalidPage:!1,isDestroyed:!1,isDone:!1,isPaused:!1,isBeyondMaxPage:!1,currPage:1},dataType:"json",appendCallback:!1,pathParse:function(a){return a=a.match(/^(.*?)2(\..*?$)/).slice(1)},maxPage:a-1},function(a,c,d){a.data.length>0?b.ajaxCallback(a):$(b.defaults.container).infinitescroll("destroy")})},getData:function(){var a=this,b="";return this.defaults.json_index&&(b=this.defaults.json_index+1),$.ajax({url:a.defaults.url+a.defaults.jsonpath+"/data"+b+".json?p="+(new Date).getTime(),type:"GET",dataType:"json"})},ajaxCallback:function(a){var b=this;$(this.defaults.container).infinitescroll("pause"),this.defaults.json_index++,a.itemW=this.defaults.itemW,a.json_index=this.defaults.json_index,a.content_mar=this.defaults.content_mar;var c=_.template($("#Id_stream_tmpl").html(),a),d=$($.parseHTML(c));d.find("img").css({opacity:0}),d.imagesLoaded(function(){if(d.find("img").css({opacity:1}),$(b.defaults.container).append(d).masonry("appended",d,!0),b.defaults.json_index<b.defaults.loadPageSize)$(b.defaults.container).infinitescroll("resume");else{if($(b.defaults.container).infinitescroll("destroy"),b.defaults.json_index===parseInt(b.defaults.totalPage)){var a=$("#clickLoading");return a.html("加载完毕！").show().off("click"),!1}$("#clickLoading").html("点击加载更多...").show()}$(document).height()>=$(window).height()&&$(window).trigger("resize")}),d.find("img").each(function(){$(this).imagesLoaded(function(){var a=this;b.getNaturalDimensions(a.elements[0],function(c,d){$(a.elements[0]).attr({bsize_w:c,bsize_h:d}),b.resizeWidth($(a.elements[0]))})})})},getNaturalDimensions:function(a,b){var c,d=a.naturalWidth,e=a.naturalHeight;e?b(d,e):(c=new Image,c.src=a.src,c.complete&&b(c.width,c.height),c.onload=function(){b(this.width,this.height)})},resizeWidth:function(a){var b=this;b.getItemW($(b.defaults.buildContainer).width()),a.each(function(){var a=$(this).find("img");a=a.length?a:$(this);var c=a.attr("bsize_w"),d=a.attr("bsize_h"),e=b.defaults.itemW-b.defaults.content_mar,f=parseInt(e*d/c);$(this).css("width",b.defaults.itemW+"px"),e&&f&&(a.css("width",e+"px"),a.css("height",f+"px"))}),$(b.defaults.container).masonry({columnWidth:b.defaults.itemW+10-1})}}),c.exports={build:function(a){var b;return b=new d(a)}}});